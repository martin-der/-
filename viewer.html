<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	
	<link rel="stylesheet" href="https://cdn.rawgit.com/martin-work/web-util/master/static/css/common.css" />
	<script type="text/javascript" src="https://cdn.rawgit.com/martin-work/web-util/master/static/js/misc.js"></script>
	<link rel="stylesheet" href="css/viewer.css" />
	<link rel="stylesheet" href="css/viewer-main.css" />
	<link rel="stylesheet" href="https://cdn.rawgit.com/martin-work/web-util/master/static/css/stackedit/export.css" />
	<script type="text/javascript" src="js/js.cookie.js"></script>
	<script type="text/javascript" src="js/mdu.js"></script>

	<link rel="icon" type="image/png" href="image/page/viewer.png" />

	<link href="css/ui.css" rel="stylesheet" type="text/css" />

	<script type="text/javascript" src="js/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="js/jquery.blockUI.js"></script>
	<script src="js/jquery.growl.js" type="text/javascript"></script>
	<link href="css/jquery.growl.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/tooltipster.bundle.min.js"></script>
	<link href="css/tooltipster.bundle.min.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/handlebars-v4.0.5.js"></script>
	<script type="text/javascript" src="js/jss.js"></script>
	<!--script type="text/javascript" src="js/showdown.min.js"></script-->
	<!--script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script-->
	<!--script type="text/javascript" src="js/MathJax.js"></script-->

	<script type="text/javascript" src="js/Markdown.Converter.js"></script>
	<script type="text/javascript" src="js/Markdown.Sanitizer.js"></script>
	<script type="text/javascript" src="js/Markdown.Editor.js"></script>
	<!--script type="text/javascript" src="js/prettify.js"></script-->
	<script type="text/javascript" src="js/Markdown.Extra.js"></script>

	<script type="text/javascript" src="js/raphael-min.js"></script>
	<script type="text/javascript" src="js/underscore-min.js"></script>
	<script type="text/javascript" src="js/sequence-diagram-min.js"></script>
	<script type="text/javascript" src="js/flowchart-latest.js"></script>



	<script type="text/javascript" src="js/markdown-display.js"></script>
	<!--link rel="stylesheet" href="css/markdown.css"></script-->

	<script type="text/javascript" src="js/theme.js"></script>

	<script src="js/jspdf.min.js"></script>
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>

	<script type="text/javascript" src="config.js"></script>

</head>
<body>

	<script id="markdown-display_on-the-fly-loader" ></script>

	<script id="header-template" type="text/x-handlebars-template">
		<div style="display: inline-block; text-align: initial;">
			<table>
				<tr>
					<td>
						<!--img src="image/theme/logo-50px.png?raw" /-->
					</td>
					<td>
						<h1 class="title"><span class="title"></span></h1>
					</td>
					<td>
						<!--img src="image/theme/logo-50px.png" /-->
					</td>
				</tr>
			</table>
		</div>
	</script>
	<script id="footer-template" type="text/x-handlebars-template">
		<span>
			{{author.name}}<br/>
			bla bla bla
		</span>
	</script>
	
	<script  type="text/javascript">
	//<![CDATA[


		jQuery.support.cors = true;
		
		config.data.author.name = "Martin Salazard";
		config.data.author.email = "msalazard@externe.generali.fr";

	
		var themeConfigurator = new Theme.Configurator({
			post_process : {
				done : function(theme, context) {
					if (context.trigger == 'setup') {
						jQuery.growl.notice({title: "Theme loaded", message: "Actual theme is '"+theme.label+"'"});
					} else {
						jQuery.growl.notice({title: "Theme changed", message: "Theme now is '"+theme.label+"'"});
					}
				},
				fail : function(theme, context, failures) {
					var message;
					if (failures.length>0) {
						message = "";
						var i;
						for ( i=0 ; i<failures.length ; i++ )
							message = message + "<li>"+failures[i].url+":"+failures[i].error+"</li>";
						message = "<ul>"+message+"</ul>";
					}
					if (context.trigger == 'setup') {
						jQuery.growl.warning({title: "Cannot set theme '"+theme.label+"' ("+theme.name+")", message: message});
					} else {
						jQuery.growl.error({title: "Cannot set theme '"+theme.label+"' ("+theme.name+")", message: message});
					}
				}
			},
			default_theme : 'pdofsi',
			themes : [
				new Theme.Reference('country','Country'),
				new Theme.Reference('deepocean','Deep Ocean'),
				new Theme.Reference('essay','Essay'),
				new Theme.Reference('galactic','Galactic'),
				new Theme.Reference('google','Google'),
				new Theme.Reference('stoneage','Stone Age'),
				new Theme.Reference('subtle','Subtle'),
				new Theme.Reference('terminal','Terminal'),
				new Theme.Reference('CocoIsGone','Coco')
			],
			extra : {
				location : 'theme/generali/{0}',
				themes : [
					new Theme.Reference('pdofsi','PDO-FSI')
				]
			}
		});	

		function moveScroller() {
			var $anchor = $("body");
			var $scroller = $('#menu-button');

			var handleScroll = function() {
				var st = $(window).scrollTop();
				var ot = $anchor.offset().top;
				if (st > ot) {
					$scroller.css({
						position: "fixed",
						top: "1em", left : "1em"
					});
				} else {
					$scroller.css({
						position: "absolute",
						top: "1em", left : "1em"
					});
				}
			};
			$(window).scroll(handleScroll);
			handleScroll();
		}

		function buildTemplatedParts(data) {
			var source_template,template,html;

			source_template = config.viewer.header ? config.viewer.header : jQuery("script[id='header-template']").html();
			template = Handlebars.compile(source_template);
			html = template(data);	
			jQuery('body header').html(html);

			source_template = config.viewer.footer ? config.viewer.footer : jQuery("script[id='footer-template']").html();
			template = Handlebars.compile(source_template);
			html = template(data);	
			jQuery('body footer').html(html);
		}
		
		function updateLiveElements() {
			jQuery(".live-date").each(function() {
				var liveDate = jQuery(this);
				liveDate.html(MDU.date.toPrettyString(liveDate.attr('live-date')));
			});
			setTimeout(updateLiveElements,1000);
		}


		jQuery(function() {
		
			setTimeout(updateLiveElements,1000);

			buildTemplatedParts ( config.data );

			var blockUI_config = {
				message : null,
				fadeIn  : 0,
				fadeOut : 1500,
				overlayCSS : {
					backgroundColor : '#fff',
					opacity : 1
				}
			};
			var blockUI_menu_config = {
				baseZ : 1000,
				message : jQuery('div#menu'),
				fadeIn  : 0,
				fadeOut : 0,
				css : {
					cursor : 'default',
				},
				overlayCSS : {
					cursor : 'default',
					backgroundColor : '#000',
					opacity : 0.85
				}
			};

			var markdownBuilder = null;

			jQuery('div.menu-button').click(function() {
				var $menuButton = jQuery('div[id="menu-button"]');
				jQuery.blockUI(blockUI_menu_config);
				jQuery(this).toggleClass('open').promise().done(function(){
					if (!jQuery(this).hasClass('open')) {
						jQuery.unblockUI(blockUI_menu_config);
						$menuButton.addClass('reverse-boo');
					} else {
						$menuButton.removeClass('reverse-boo');
					}
				});
			});

			try {
				themeConfigurator.setup();
			} catch (ex) {
				jQuery.growl.warning({title: "Cannot set theme", message: ex});
			}
			moveScroller();
	
			var content_selector = "div.container>div.content";
			var title_selector = "span.title";
			var all_selector = content_selector+","+title_selector;

			var build_result;

			var specialElementHandlers = {
				'#tools': function (element,renderer) {
					return true;
				}
			};

			jQuery('#download').click(function () {
				var doc = new jsPDF();
				doc.fromHTML(jQuery('div#exported-content').html(), 15, 15, {
					'width': 170,'elementHandlers': specialElementHandlers
				});
				doc.save((build_result?build_result.title:'untitled')+'.pdf');
			}).css('cursor','pointer');
			
			//var stash_prefix = 'http://git.groupe.generali.fr';
			var stash_prefix = 'http://gf215739/git-stash';
			
			markdownBuilder = new MarkdownDisplay.Builder({
				content : {
					source : {
						url_parameter : 'md'
					},
					target : {
						title_selector : title_selector,
						content_selector : content_selector
					},
					nameToURLConverters : [
						MarkdownDisplay.config.NameToURLConverters.GITHUB_DEVELOP,
						MarkdownDisplay.config.NameToURLConverters.GITHUB,
						new MarkdownDisplay.NameToURLConverter ( /^generali\/~([^\/]+)\/([^\/]+)\/(.+)!$/ , stash_prefix+'/users/{0}/repos/{1}/browse/{2}?at=develop&raw'),
						new MarkdownDisplay.NameToURLConverter ( /^generali\/~([^\/]+)\/([^\/]+)\/(.+)$/ , stash_prefix+'/users/{0}/repos/{1}/browse/{2}?at=master&raw'),
						new MarkdownDisplay.NameToURLConverter ( /^generali\/([^\/]+)\/(.+)!$/ , stash_prefix+'/users/b010cdx/repos/{0}/browse/{1}?at=develop&raw'),
						new MarkdownDisplay.NameToURLConverter ( /^generali\/([^\/]+)\/(.+)$/ , stash_prefix+'/users/b010cdx/repos/{0}/browse/{1}?at=master&raw'),
						new MarkdownDisplay.NameToURLConverter ( /^doc\/(.+)!$/ , stash_prefix+'/users/b010cdx/repos/web-static/browse/{0}?at=develop&raw' ),
						new MarkdownDisplay.NameToURLConverter ( /^doc\/(.+)$/ , stash_prefix+'/users/b010cdx/repos/web-static/browse/{0}?at=master&raw' ),
						new MarkdownDisplay.NameToURLConverter ( /^ldoc\/(.+)$/ , '/doc/{0}' )
					],
				},
				pre_process : {
					build : function(data) {
						jQuery(all_selector).css('visibility','hidden').css('opacity','0');
						return true;
					}
				},
				post_process : {
					done : function(data) {
						jQuery(content_selector).find('pre>code').each(function(i, block) {
							hljs.highlightBlock(block);
							if (jQuery(block).hasClass('hljs'))
								jQuery(block).removeClass('hljs');
						});
						jQuery(all_selector).css('visibility','visible').animate({opacity:1},1000);
						jQuery(title_selector).tooltipster({
							interactive : true,
							side : 'bottom',
							delay : [ 0, 350 ],
							//animation : 'swing',
							functionInit : function(instance, helper) {
								var infoTable = jQuery("<table>");
								if (data.source.url)
									infoTable.append( '<tr><td>URL</td><td><a href="'+data.source.url+'">' + MDU.XML.escape(data.source.url) +  '</a></td></tr>' )
								if (data.source.simplified_url)
									infoTable.append( '<tr><td>Simplified URL</td><td>' + MDU.XML.escape(data.source.simplified_url) +  '</td></tr>' )
								if (data.source.modification_date)
									infoTable.append( '<tr><td>Modified</td><td><span class="live-date" live-date="'+data.source.modification_date+'">' + MDU.XML.escape(data.source.modification_date.toLocaleString()) +  '</span></td></tr>' )
									
								instance.content(infoTable[0]);
							},
							functionReady : function(instance, helper) {
								jQuery(helper.tooltip).find(".live-date").each(function(){
									var liveDate = jQuery(this);
									liveDate.html(MDU.date.toPrettyString(liveDate.attr('live-date')));
								});
							}
						});
					},
					fail : function(data, error) {
						jQuery.growl.error({ title: "Load failed", fixed:true, message: "Loading '"+data.source.url+"' : "+error });
					}
				}
			});

			build_result = markdownBuilder.acquireThenBuild();
		});
	//]]>
	</script>

	<div id="menu-button" class="reverse-boo" style="z-index : 2000 ; position:absolute; top:1em; left:1em">
		<!--div class="menu-button flavor-a">
		  <span></span>
		  <span></span>
		  <span></span>
		</div-->
		<div class="menu-button flavor-b">
		  <span></span>
		  <span></span>
		  <span></span>
		  <span></span>
		  <span></span>
		  <span></span>
		</div>
		<!--div class="menu-button flavor-c">
		  <span></span>
		  <span></span>
		  <span></span>
		  <span></span>
		</div>
		<div class="menu-button flavor-d">
		  <span></span>
		  <span></span>
		  <span></span>
		</div-->
	</div>

	<div id="menu" style="display:none">
		<table class="option">
			<tr>
				<td>Theme</a>
				<td>
					<select id="theme" />
				</td>
			</tr>
			<tr>
				<td>Date</a>
				<td>
					<input type="checkbox" value="Use default" >Custom format </input><input type="text" />
				</td>
			</tr>

		</table>
		<table>
			<tr>
				<td>
					<a id="share">Sh</a>
				</td>
				<td>
					<a id="download">Dl</a>
				</td>
			</tr>
		</table>
	</div>


	<div id="exported-content" class="viewer body" style="text-align: center">
		<div style="display: inline-block; text-align: initial;">
			<table>
				<tr>
					<td>
						<header class="main-container" style="text-align: center" />
					</td>
				</tr>
				<tr>
					<td>
						<div class="main-container container"><div class="content markdown"></div></div>
					</td>
				</tr>
				<tr>
					<td>
						<footer class="main-container reverse-boo" style="font-size: 0.8em; text-align : center" />
					</td>
				</tr>
			</table>
		</div>
	</div>
</body>
</html>
